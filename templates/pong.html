<!DOCTYPE html> 
<html>
<head>
  <title>Pong!</title> 
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='semantic.min.css') }}">
  <link href="{{ url_for('static', filename='pong.css') }}" media="screen, print" rel="stylesheet" type="text/css" /> 
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/semantic.min.js') }}"></script>
  <style>
    img { 
      width: 360px; 
      height: 360px;

    }
    #wrapper {
      display: flex
    }
    #canvas_chart_1 {
      flex:0 0 33%;
      padding-left: 100px;
    }
    #stream {
      flex:1 0 33%;
    }
    #canvas_chart_2 {
      flex:2 0 33%;
      padding-right: 100px
    }
    #video_left {
      width: 460px;
      padding-right: 50px;
      padding-left: 50px;
    }
    #video_right {
      width: 460px;
      padding-right: 50px;
      padding-left: 50px;
    }
    #game_wrapper {
      padding-top: 20px
    }
    #sidebar {
      display: none;
    }
    #game {
      width: 800px;
      height: 600px;
    }


  </style>
  <script src="http://www.chartjs.org/dist/2.7.2/Chart.bundle.js"></script>
</head> 
 
<body style="padding: 0px"> 
  <div id="wrapper">
    <div id="container_chart_1">
        <canvas id="canvas_chart_1"></canvas>
    </div>
    <div id='stream'>

    </div>
    <div id="container_chart_2">
        <canvas id="canvas_chart_2"></canvas>
    </div>
  </div>
  <div id="sidebar" style="display:none">

    <h2>This is Pong!</h2>

    <div class='description'>
      <p>
        This is a javascript version of Pong.
      </p>
      <p>
        Press <b>1</b> for a single player game.<br>
        Press <b>2</b> for a double player game.<br>
        Press <b>0</b> to watch the computer play itself.
      </p>
      <p>
        Player 1 moves using the <b>Q</b> and <b>A</b> keys.<br>
        Player 2 moves using the <b>P</b> and <b>L</b> keys.
      </p>
      <p>
        <b>Esc</b> can be used to abandon a game.
      </p>
    </div>

    <div class='settings'>
      <label for='sound'>sound: </label>
      <input type='checkbox' id='sound'>
    </div>

    <div class='settings'>
      <label for='stats'>stats: </label>
      <input type='checkbox' id='stats' checked>
    </div>

    <div class='settings'>
      <label for='footprints'>footprints: </label>
      <input type='checkbox' id='footprints'>
    </div>

    <div class='settings'>
      <label for='predictions'>predictions: </label>
      <input type='checkbox' id='predictions'>
    </div>

  </div>
  <div id="game_wrapper">
    <img id="video_left" src="{{ url_for('video_feed_left') }}">
        
    <canvas id="game">
      <div id="unsupported">
        Sorry, this example cannot be run because your browser does not support the &lt;canvas&gt; element
      </div>
    </canvas>

    <img id="video_right" src="{{ url_for('video_feed_right') }}">
  </div>

  <script type="text/javascript">
    // images
    var url_press1 = "{{ url_for('static', filename='images/press1.png') }}";
    var url_press2 = "{{ url_for('static', filename='images/press2.png') }}";
    var url_winner = "{{ url_for('static', filename='images/winner.png') }}";
    // sounds
    var url_ping = "{{ url_for('static', filename='sounds/ping.wav') }}";
    var url_pong = "{{ url_for('static', filename='sounds/pong.wav') }}";
    var url_wall = "{{ url_for('static', filename='sounds/wall.wav') }}";
    var url_goal = "{{ url_for('static', filename='sounds/goal.wav') }}";

  </script>
  <script src="{{ url_for('static', filename='js/game.js') }}" type="text/javascript"></script> 
  <script src="{{ url_for('static', filename='js/pong.js') }}" type="text/javascript"></script>
  <script type="text/javascript">
  let pong = '';
  Game.ready(function() {

    var size        = document.getElementById('size');
    var sound       = document.getElementById('sound');
    var stats       = document.getElementById('stats');
    var footprints  = document.getElementById('footprints');
    var predictions = document.getElementById('predictions');

    pong = Game.start('game', Pong, {
      sound:       sound.checked,
      stats:       stats.checked,
      footprints:  footprints.checked,
      predictions: predictions.checked
    });

    Game.addEvent(sound,       'change', function() { pong.enableSound(sound.checked);           });
    Game.addEvent(stats,       'change', function() { pong.showStats(stats.checked);             });
    Game.addEvent(footprints,  'change', function() { pong.showFootprints(footprints.checked);   });
    Game.addEvent(predictions, 'change', function() { pong.showPredictions(predictions.checked); });

  });
  </script>
  <!--<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>-->
  
  <script type="text/javascript">
    var horizontalBarChartData = {
      labels: ['Angry', 'Disgust', 'Fear', 'Happy', 'Sad', 'Surprise', 'Neutral'],
      datasets: [{
        backgroundColor: 'white',
        borderColor: 'white',
        borderWidth: 1,
        data: [
          0,0.2,0.3,0,0,0.1,0.4
        ]
      }]
    };
    Chart.scaleService.updateScaleDefaults('linear', {
      ticks: {
            max: 1.0,
            min: 0.0,
            stepSize: 0.1
      }
    });
    window.onload = function() {
      var ctx = document.getElementById('canvas_chart_1').getContext('2d');
      window.chart_left = new Chart(ctx, {
        type: 'horizontalBar',
        data: horizontalBarChartData,
        options: {
          // Elements options apply to all of the options unless overridden in a dataset
          // In this case, we are setting the border of each horizontal bar to be 2px wide
          elements: {
            rectangle: {
              borderWidth: 2,
            }
          },
          responsive: true,
          legend: {display: false}
        }
      });

      var ctx2 = document.getElementById('canvas_chart_2').getContext('2d');
      window.chart_right = new Chart(ctx2, {
        type: 'horizontalBar',
        data: horizontalBarChartData,
        options: {
          // Elements options apply to all of the options unless overridden in a dataset
          // In this case, we are setting the border of each horizontal bar to be 2px wide
          elements: {
            rectangle: {
              borderWidth: 2,
            }
          },
          responsive: true,
          legend: {display: false}  
        }
      });

    };
  </script>
  <script type="text/javascript">
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function getExpressions() {
      for (;;) {
        await sleep(100);
        $.get("expressions", function( data ) {
            data = JSON.parse(data)
            if (data.length > 0) {
              window.chart_left.data.datasets[0].data = data[0];
              window.chart_left.update();
            }
            if (data.length > 1) {
              window.chart_right.data.datasets[0].data = data[1];
              window.chart_right.update();
            }

            if(data.length > 0){
              if(data[0][3] > 0.5){
                pong.leftPaddle.stopMovingDown();
                pong.leftPaddle.moveUp();
              }
              else{
                pong.leftPaddle.stopMovingUp();
                pong.leftPaddle.moveDown();
              }
            }
        });
      }
    }

    getExpressions();
    /*
    var socket = io.connect('http://' + 'localhost' + ':' + 5000);
    socket.on('connect', function() {
        // we emit a connected message to let knwo the client that we are connected.
        //socket.emit('client_connected', {data: 'New client!'});
        socket.send('json_button', {message: "test"});
    });
    socket.on('message', function (data) {
        console.log('message from backend ' + data);

        // request new frame
        socket.send('json_button', {message: "test"});
    });
    */
    //let ws = new WebSocket('ws://localhost:6000');
  </script>  

</body> 
</html>
